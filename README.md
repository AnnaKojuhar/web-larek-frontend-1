# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
## Данные и типы данных, используемые в приложении

Карточка, которая приходит с сервера и используется в модальном окне
```
interface ICard {
    id: string;
    description: string;
    image: string;
    title: string;
    category: string;
    price: number;
}
```

Карточка на главном экране
```
type TCardMain = Omit<ICard, 'description'>;
```

Карточка в корзине
```
type TCardBasket = Pick<ICard, 'id' | 'title' | 'price'>;
```

Интерфейс для модели данных карточек
```
interface IProductsData {
    cards: ICard[];
    getCard(cardId: string): ICard
}
```
Тип оплаты
```
type IPayment = 'online' | 'offline';
```
Интерфейс заказа
```
interface IOrder {
    payment: IPayment;
    email: string;
    phone: string;
    address: string;
    total: number;
    items: string[];
}
```
Данные по доставке, которые вводит пользователь
```
type TOrderDelivery = Pick<IOrder, 'payment' | 'address'>;
```
Личные данные пользователя
```
type TOrderUserData = Pick<IOrder, 'email' | 'phone'>;
```
Ошибки форм
```
type FormErrors = Partial<Record<keyof IOrder, string>>;
```
Поля ввода
```
type TInputName = 'email' | 'phone' | 'address';
```
Интерфейс ошибки, возвращаемой с сервера
```
interface IError {
    error: string;
}
```
Интерфейс успешно принятого заказа с сервера
```
interface IOrderResult {
    id: string;
    total: number;
}
```


## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP: 
- слой представления, отвечает за отображение данных на странице, 
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие   

### Слой данных


#### Класс CardsData
Класс отвечает за хранение и логику работы с данными карточек созданных пользователями.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:
- _cards: ICard[] - массив объектов карточек
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- getCard(cardId: string): ICard - возвращает карточку по ее id
- сеттеры и геттеры для сохранения и получения данных с полей класса

#### Класс AppState
Класс отвечает за хранение и логику работы с данными текущего заказа.\
Конструктор класса принимает инстант брокера событий и класс каталога
В полях класса хранятся следующие данные:
- events: IEvents; - экземпляр класса `EventEmitter` для инициации событий при изменении данных.
- catalog: ICardsData; экземпляр класса `CardData` для работы с каталогом
- _payment: IPayment; - способ оплаты
- _email: string; - электронная почта покупателя
- _phone: string; - номер покупателя
- _address: string; - адрес покупателя
- _total: number; - общая сумма заказа
- _basket: ICard[]; - корзина
- formErrors: FormErrors = {}; - массив для хранения ошибак валидации


Так же класс предоставляет набор методов для взаимодействия с этими данными.
- getOrder(): IOrder - возвращает данные заказа
- hasBasket(id: string): boolean; - проверяет наличие карточки в корзине
- addToBasket(id: string): void - добавление товара в корзину
- deleteFromBasket(id: string): void - удаление товара из корзины
- clearBasket(): void - очистить корзину
- getBasket(): TBasket - возвращает корзину
- getCounter(): number - возвращает количество товаров в корзине
- setOrderField(field: TInputName, value: string, formName: string): void - устанавливает значение вводимое в полях
- validateOrder(formName: string): void - проверяет вводимые значения
- сеттеры и геттеры для сохранения и получения данных с полей класса


### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Базовый Класс Component
Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод render, отвечающий за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.

#### Класс Card 
Абстрактный класс который отвечает за базовае отображение всех карточек, задавая в карточке данные названия и цену. Класс используется. В конструктор класса передается клон темплейта, инстант брокера событий и функцию, которая будет вызываться при нажатии кнопки. В классе устанавливаются слушатели на кнопку или на всю карточку.\
В полях класса хранятся следующие данные:
- events: IEvents; - экземпляр класса `EventEmitter` для инициации событий при изменении данных.
- _id: string - id карточки
- _payment: IPayment; - способ оплаты
- _button: HTMLButtonElement; - элемент кнопки
- _title: HTMLElement; - элемент имени
- _price: HTMLElement; - элемент цены

Методы:
- сеттеры и геттеры для сохранения и получения данных с полей класса

#### Класс CardBasket
Класс расширяет класс `Cаrd` и используется для отображения карточки в корзине.\
Данные класса:
- _itemIndex: HTMLElement; - элемент порядкового номера в корзине

Методы:
- сеттер itemIndex(value: number) - устанавлявает значение для _itemIndex

#### Класс CardCatalog
Класс расширяет класс `Cаrd` и используется для отображения карточки на главной странице.\
Данные класса:
- _image: HTMLImageElement; - элемнет картинки
- _category: HTMLElement; - элемент категории

Методы:
- сеттеры для установки данных класса

#### Класс CardPreview
Класс расширяет класс `CаrdCatalog` и используется для отображения карточки на главной странице.\
Данные класса:
- _text: HTMLElement; - элемент текста

Методы:
- сеттер text(value: string) - устанавливает значение _text
- setButtonText(value: boolean): void - устанавливает текст кнопки

#### Класс Page 
Класс нужен для отображения информации на главном экране. В конструктор класса передается компонент разметки и инстант брокера событий.\
Поля класса:
- _counter: HTMLElement; - элемент отображения количества эл-тов в корзине
- _catalog: HTMLElement; - элемент для отображения каталога
- _wrapper: HTMLElement; - элемент для блокирования действий на странице при открытии модального окна
- _basket: HTMLElement; - элемент кнопки открытия корзины

Методы:
- сеттеры для установки данных класса

#### Класс Modal
Реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.\
Поля класса
- _closeButton: HTMLButtonElement;
- _content: HTMLElement;

Методы
- open(): void; - открывает модальное окно
- close(): void; - удаляет контент и закрывает модальное окно;
- render(data: IModalData): HTMLElement - заполняет контент и открывает модальное окно

#### Класс Basket
Отвечает за отображение корзины в модальном окне. В конструктор принимает темплейт корзины и экземпляр `EventEmitter` для инициации событий при нажатии пользователем на кнопки. Устанавливает в конструкторе слушатели на кнопку, при срабатывании которых генерируются соответствующие событие\
Поля класса:
- _list: HTMLElement; - элемент для отображения массива карточек
- _total: HTMLElement; - элемент для отображения общей суммы корзины
- _button: HTMLElement; - элемент кнопки для продолжения оформления товара

Методы:
- сеттеры для установки данных класса

#### Класс Form 
Родительский класс всех форм на странице. Отвечает за реагирование форм на валидацию, за работу кнопки типа `submit`. В конструктор принимает темплейт формы и экземпляр `EventEmitter` так же в конструкторе устанавливаются слушатели на все инпуты и кнопку.\
Поля класса:
- _submit: HTMLButtonElement; - кнопка типа `submit`
- _errors: HTMLElement; - элемент для вывода ошибок валидации
- _formName: string; - имя формы

Методы
- сеттеры для установки данных класса

#### Класс OrderDelivery
Наследуется от класса `Form` и отвечает за работу форму для получания информации о доставке. Отвечает за реагирование форм на валидацию, за работу кнопок выбора типа оплаты.\
Поля класса:
- buttons: NodeListOf<HTMLButtonElement>; - массив кнопок

Методы
- сеттер buttonPayment(payment: IPayment) - отвечает за установку активной кнопки
- сеттер address(value: string) - устанавливает значание в поле address

#### Класс OrderDelivery
Наследуется от класса `Form` и отвечает за работу форму для получания контактов покупателя. Отвечает за реагирование форм на валидацию.\
Методы класса:
- set phone(value: string) - устанавливает значание в поле phone
- set email(value: string) - устанавливает значание в поле email

### Слой коммуникации

#### Класс larekApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.\
Методы класса:
- getCard(id: string): Promise<ICard> - получение данных картоки по id
- getCardsList(): Promise<ICard[]> - получение массива карточек
- order(order: IOrder): Promise<IOrderResult> - отправить заказ


## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделями данных)*
- `cards:changed` - изменение массива карточек
- `card:selected` - изменение открываемой в модальном окне картинки карточки
- `basket:change` - изменение кол-ва позиций в корзине
- `orderDelivery:valid` - форма с доставкой заполнена
- `orderUserData:valid` - форма с контактами заполнена
- `formErrors:change` - изменение ошибок валидации

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `modal:open` - открытие модального окна
- `modal:close` - закрытие модального окна
- `preview:open` - открытие превью
- `basket:add/remove` - добавление/удаление карточки
- `basket:open` - открытие модального окна с корзиной
- `order:open` - открытие модального окна с формой доставки
- `payment:change` - изменение способа оплаты
- `orderDelivery:submit` - отправка данных формы доставки
- `orderUserData:submit` - отправка данных формы кантактов
- `orderDelivery.address:change` - изменение в поле адреса
- `orderUserData.mail:change` - изменение в поле почты
- `orderUserData.phone:change` - изменение в поле телефона